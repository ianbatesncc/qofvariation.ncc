---
title: "QOF variation dashboard"
author: "Ian Bates"
output: 
    flexdashboard::flex_dashboard:
    orientation: rows
    source_code: embed
    vertical_layout: fill # scroll
    runtime: shiny
---

```{r setup, include = FALSE, cache = FALSE}
require("flexdashboard")
require("shiny")
#require("d3heatmap")
require("DT")

knitr::opts_chunk$set(cache = FALSE)
knitr::opts_chunk$set(echo = FALSE)

```

```{r global, include = FALSE, cache = TRUE}
# load data in 'global' chunk so it can be shared by all users of the dashboard

taskdir <- normalizePath("..")
source(file = paste(taskdir, "Analysis/main.R", sep = "/"))
#source(file = paste(taskdir, "Analysis/cdg_91_qof.R", sep = "/"))

#dat <- main(qof_period = "1516", bProcessRaw = FALSE, bLoadData = FALSE)
dat <- main(qof_period = "1617", bProcessRaw = FALSE, bLoadData = FALSE)

l_add_orgtag <- function(x, c1 = "ccg_code", c2 = "practice_code") {
    x %>%
        mutate(
            orgtag = paste(
                UQ(rlang::sym(c1))
                , UQ(rlang::sym(c2))
            )
        ) %>% invisible()
}

# Add ccg group lookup
lu.orgs.ccgs.groups <- fread(
    file = paste_paths(taskdir, "./Results/lu__ccg_groups.csv")
) #%>% l_add_orgtag("ccg_group_type", "ccg_group_code")

# Add display order
#
# Based on ccg_group_type.  CCGs go to 10, practices go to 20.
l_add_display_order <- function(x, c1 = "org.type") {
    #names(x) %>% print()
    x %>% 
        merge(
            lu.orgs.ccgs.groups %>% 
                select(ccg_group_code, display_order = type_display_order) %>%
                unique()
            , by.x = "practice_code", by.y = "ccg_group_code"
            , all.x = TRUE
        ) %>%
        mutate(display_order = ifelse(UQ(rlang::sym(c1)) == "england", 0, display_order)) %>%
        mutate(display_order = ifelse(UQ(rlang::sym(c1)) == "ccg", 10, display_order)) %>%
        mutate(display_order = ifelse(is.na(display_order), 20, display_order))
}

# actually load data
orgref <- dat$reference$orgref #%>% l_add_orgtag()
indmap <- dat$reference$indmap
measures <- dat$measures %>% l_add_display_order() #%>% l_add_orgtag()
compare <- dat$compare %>% l_add_display_order("org.type.var") #%>% l_add_orgtag()

practice_grouping <- list(
    orgref %>% 
        # filter out existing ccg groups
        filter(nchar(practice_code) > 3) %>%
        select(practice_code, ccg_code) %>%
        merge(lu.orgs.ccgs.groups, by = "ccg_code", all.y = TRUE) %>%
        select(-type_display_order)
    
    , orgref %>% 
        # filter out existing ccg groups
        filter(nchar(practice_code) > 3) %>%
        # only local ccgs
        filter(ccg_code %in% c(lu.orgs.ccgs.groups$ccg_code %>% unique())) %>%
        select(practice_code, ccg_code) %>%
        mutate(
            ccg_group_type = "ccg"
            , ccg_group_type_name = "ccg"
            , ccg_group_code = ccg_code
            , ccg_group_name = ccg_code
        )
) %>%
    # lapply(function(x){sort(names(x))}) 
    rbindlist(use.names = TRUE)

# For inputs

these_orgtypes <- measures$org.type %>% unique() %>% sort()
these_ccg_groups <- practice_grouping$ccg_group_name %>% unique() %>% sort()
these_ccgs <- measures$ccg_code %>% unique() %>% sort()
these_practices <- practice_grouping$practice_code %>% unique() %>% sort()

these_ind_groups <- measures$indicator_group_code %>% unique() %>% sort()
these_inds <- measures$indicator_code %>% unique() %>% sort()

these_measures <- measures$m.name %>% unique() %>% sort()

these_comparisons <- compare$compare.type %>% unique() %>% sort()
these_comparisons_param <- compare$compare.param  %>% unique() %>% sort()

these_comparators <- compare$org.type.ref %>% unique() %>% sort()


# for e.g. Heatmap

lu_statsig_num <- fread(input = "
statsig,istatsig
Better,1
Higher,1
Similar,0
Lower,-1
Worse,-1
Not tested,NA
"
)

```


Heatmap
====

Inputs {.sidebar}
-----------------------------------------------------------------------

Show variation in QOF.

```{r heatmap_inputs}

bRenderD3 = FALSE
bRenderggplot = TRUE
cat("INFO: possible input selections here", "\n")


selectInput(
    "hm__this_ccg_group"
    , label = "Select Practice grouping:"
    , choices = these_ccg_groups
    , selected = these_ccg_groups[1]
)

selectInput(
    "hm__this_measure"
    , label = "Select measure:"
    , choices = these_measures
    , selected = "exceptions" # these_measures[1]
)

selectInput(
    "hm__this_comparison_method"
    , label = "Select comparison method:"
    , choices = these_comparisons
    , selected = "spc" # these_comparisons[1]
)

selectInput(
    "hm__this_comparator"
    , label = "Select comparator:"
    , choices = these_comparators
    , selected = "england" # these_comparators[1]
)

if (bRenderD3) {
    
    checkboxInput("hm__group_rows", "Group rows", FALSE)
    checkboxInput("hm__group_cols", "Group cols", FALSE)
    
}

```


Row
-----------------------------------------------------------------------

### Heatmap

```{r heatmap_render}

#cat("INFO: Heatmap", "\n")

#this_orgtype <- reactive(input$this_orgtype)
#this_ccg <- reactive(input$this_ccg)
hm__this_ccg_group <- reactive(input$hm__this_ccg_group)
hm__this_measure <- reactive(input$hm__this_measure)
hm__this_comparator <- reactive(input$hm__this_comparator)
hm__this_comparison_method <- reactive(input$hm__this_comparison_method)
#this_comparison_param <- reactive(input$this_comparison_param)

hm__tmp_practices_list <- reactive({
    
    # every time
    global_orgs <- c("eng", "n2")
    
    # relevant orgs
    relevant_orgs <- 
        lu.orgs.ccgs.groups %>%
        filter(
            ccg_code %in% 
                (lu.orgs.ccgs.groups %>% filter(
                    ccg_group_name == hm__this_ccg_group() |
                        ccg_code == hm__this_ccg_group()
                ) %>% .$ccg_code)
        ) %>%
        .$ccg_group_code %>% unique()
    
    # practices
    relevant_practices <-
        practice_grouping %>%
        filter(ccg_group_name == hm__this_ccg_group()) %>%
        #.$practice_code %>%
        select(practice_code) %>% unlist() %>% as.vector()
    
    c(global_orgs, relevant_orgs, relevant_practices) %>% unique() %>% invisible()
})


if (bRenderggplot) {
    
    hm__heatmap_dat__ggplot <- reactive({
        this_dat <- compare %>%
            # filter on measure and comparison
            filter(
                m.name == hm__this_measure()
                , org.type.ref == hm__this_comparator()
                , compare.type == hm__this_comparison_method()
            ) %>%
            # filter on practices of interest
            filter(practice_code %in% hm__tmp_practices_list()) %>%
            mutate(
                xticklabel = paste(indicator_group_code, indicator_code)
                , yticklabel = paste(ccg_code, practice_code)
            ) %>%
            select(display_order, xticklabel, yticklabel, compare.param, statsig) %>%
            merge(lu_statsig_num, by = "statsig") %>%
            # this handles benchmark and spc    
            #dcast(ccg_code + practice_code ~ indicator_code, value.var = "istatsig", fun = sum)
            group_by_at(vars(-compare.param, -istatsig, -statsig)) %>%
            summarise_at(vars(istatsig), sum) %>%
            ungroup() %>%
            # try to sort for plot
            mutate(
                yticklabel_ordered = factor(yticklabel)
                , yticklabel_ordered = reorder(yticklabel_ordered, desc(yticklabel))
                , yticklabel_ordered = reorder(yticklabel_ordered, desc(display_order))
            )

        this_dat %>% invisible()
        
    })
    
    renderPlot({
        # prepare matrix from reactive() components
        
        require("ggplot2")
        
        p__base_size <- 12
        
        p <- ggplot(
            hm__heatmap_dat__ggplot()
            #, aes(x = indicator_code, y = practice_code)
            , aes(x = xticklabel, y = yticklabel_ordered)
        ) + 
            geom_tile(aes(fill = istatsig), colour = "white") + 
            #scale_fill_gradient(low = "white", high = "steelblue") +
            #    this_col = colorRampPalette(c("#6666cc", "#ffffee", "#cc8888"), space = "Lab")(5)
            scale_fill_gradient2(
                low = "#6666cc"
                , mid = "#ffffee"
                , high = "#cc8888"
                , na.value = "#eeeeee"
                , space = "Lab") +
            # styling
            theme_grey(base_size = p__base_size) + 
            labs(x = "", y = "") + 
            scale_x_discrete(
                expand = c(0, 0), position = "top"
            ) +
            scale_y_discrete(expand = c(0, 0)) +
            theme(
                legend.position = "none"
                , axis.ticks = element_blank()
                , axis.text.x = element_text(
                    size = max(7, p__base_size * 0.67)
                    , angle = 60 # 45 30
                    , hjust = 0
                    , colour = "grey50"
                )
            )
        
        p %>% print()
        
    })
    
}

if (bRenderD3) {
    
    hm__this_group_rows <- reactive(input$hm__group_rows)
    hm__this_group_cols <- reactive(input$hm__group_cols)
    
    hm__heatmap_dat__d3 <- reactive({
        this_dat <- compare %>%
            # filter on measure and comparison
            filter(
                m.name == hm__this_measure()
                , org.type.ref == hm__this_comparator()
                , compare.type == hm__this_comparison_method()
            ) %>%
            # filter on practices of interest
            filter(practice_code %in% hm__tmp_practices_list()) %>%
            mutate(
                xticklabel = paste(indicator_group_code, indicator_code)
                , yticklabel = paste(ccg_code, practice_code)
            ) %>%
            #select(ccg_code, practice_code, indicator_code, compare.param, statsig) %>%
            select(xticklabel, yticklabel, compare.param, statsig) %>%
            merge(lu_statsig_num, by = "statsig") %>%
            # this handles benchmark and spc    
            dcast(xticklabel ~ yticklabel, value.var = "istatsig", fun = sum)
        
        rownames(this_dat) <- this_dat %>%
            select(xticklabel)
        
        this_dat <- this_dat %>% select(-ends_with("_code"))
        
        this_dat %>% invisible()
        
    })
    
    renderD3heatmap({
        # prepare matrix from reactive() components
        
        # ... and plot
        
        #this_col = colorRampPalette(c("blue", "yellow", "red"), space = "Lab")(5)
        #this_col = "RdYlBu"
        this_col = colorRampPalette(c("#6666cc", "#ffffee", "#cc8888"), space = "Lab")(5)
        this_idendrogram <- c(hm__this_group_rows(), hm__this_group_cols()) %*% c(1, 2) + 1
        #this_idendrogram <- c(input$group_rows, input$group_cols) %*% c(1, 2) + 1
        
        dendrogram_opts <- c("none", "row", "column", "both")
        
        #print(dendrogram_opts[this_idendrogram])
        
        d3heatmap(
            hm__heatmap_dat__d3()
            , colors = this_col
            , dendrogram = dendrogram_opts[this_idendrogram]
        )
    })
}

```


Stacked bars
====

Row {.tabset}
-----------------------------------------------------------------------

### Tab 1

```{r stacked_tab1}
# renderPlot(
#   parallelCoordinates(BicatYeast, res, number = num())
# )

cat("INFO: tab 1", "\n")

```

### Tab 2

```{r stacked_tab2}

cat("INFO: tab 2", "\n")

# only display table for values in cluster 4
# renderTable(
#   BicatYeast[which(res@RowxNumber[, num()]), which(res@NumberxCol[num(), ])]
# )

```


Practice detail
====

Inputs {.sidebar}
-----------------------------------------------------------------------

Show QOF dat for practice.


```{r practicedetail_input}

selectInput(
    "pd__this_ccg_group"
    , label = "Select Practice grouping:"
    , choices = these_ccg_groups
    , selected = these_ccg_groups[1]
)

selectInput(
    "pd__this_practice"
    , label = "Select Practice:"
    , choices = c("[All]", these_practices)
    #, selected = these_practices[1]
    , selected = "[All]"
)

selectInput(
    "pd__this_ind_group"
    , label = "Select indicator group:"
    , choices = c("[All]", these_ind_groups)
    #, selected = these_ind_groups[1]
    , selected = "[All]"
)

selectInput(
    "pd__this_measure"
    , label = "Select measure:"
    , choices = c("[All]", these_measures)
    , selected = "exceptions"
)

pd__this_ccg <- reactive(input$pd__this_ccg)
pd__this_practice <- reactive(input$pd__this_ccg)
pd__this_measure <- reactive(input$pd__this_measure)
pd__this_ind_group <- reactive(input$pd__this_ind_group)

```


Practice detail {.tabset}
----

### compare

```{r practicedetail_compare}
#cat("DEBUG: compare:", taskdir, "\n")
#compare %>% mutate_if(is.character, as.factor) %>% str()
#compare %>% mutate_if(is.character, as.factor) %>% summary()

pd__compare_dat <- reactive({
    compare %>% 
        filter(
            practice_code %in% pd__tmp_practices_list()
            , (pd__this_ind_group() == "[All]") | (indicator_group_code == pd__this_ind_group())
            , (pd__this_measure() == "[All]") | (m.name == pd__this_measure())
        ) %>%
        select(-org.type.var, -data_source, -m.type) %>%
        select(ccg_code, practice_code, indicator_group_code, indicator_code, org.type.ref, everything()) %>%
        dcast(... ~ compare.type + compare.param, value.var = "statsig", fun = function(x){paste(x, collapse = "")}) %>%
        mutate_if(is.character, as.factor) %>%
        invisible()
})

require("DT")

DT::renderDataTable({
    DT::datatable(
        pd__compare_dat()
        , class = "compact nowrap"
        , filter = list(position = 'top', clear = TRUE, plain = FALSE)
        , options = list(
            paging = TRUE, pageLength = 16
        )
    )
})


```

### measures

```{r practicedetail_measures}
#cat("DEBUG: measures:", taskdir, "\n")

require("DT")

DT::renderDataTable({
  this_m <- measures %>% 
    filter(
      (pd__this_ccg() == "[All]") | (ccg_code == pd__this_ccg())
      , (pd__this_practice() == "[All]") | (practice_code == pd__this_practice())
      , (pd__this_ind_group() == "[All]") | (indicator_group_code == pd__this_ind_group())
      , (pd__this_measure() == "[All]") | (m.name == pd__this_measure())
    ) %>%
    select(-org.type, -data_source, -m.type) %>%
    select(ccg_code, practice_code, indicator_group_code, indicator_code, everything()) %>%
    dcast(... ~ m.stat, fun = sum)
  
  DT::datatable(
    this_m
    , options = list(
      bPaginate = FALSE # paging = FALSE ?
    )
  ) %>%
    DT::formatRound(c("numerator", "denominator"), digits = 0) %>%
    DT::formatRound("value", digits = 1)
})

```

### orgref

```{r practicedetail_orgref}
cat("DEBUG: orgref:", taskdir, "\n")
#orgref %>% mutate_if(is.character, as.factor) %>% str()
#orgref %>% mutate_if(is.character, as.factor) %>% summary()

pd__this_ccg <- reactive(input$pd__this_ccg)
pd__this_practice <- reactive(input$pd__this_practice)
pd__all_practices <- reactive(input$pd__all_practices)

require("DT")

DT::renderDataTable({
  this_m <- orgref %>% 
    filter(
      (pd__this_ccg() == "[All]") | (ccg_code == pd__this_ccg())
      , (pd__this_practice() == "[All]") | (practice_code == pd__this_practice())
    )
  
  DT::datatable(
    this_m
    , options = list(
      bPaginate = FALSE # paging = FALSE ?
    )
  )
})
```

### indmap

```{r practicedetail_indmap}
cat("DEBUG: indmap:", taskdir, "\n")
indmap %>% mutate_if(is.character, as.factor) %>% str()
indmap %>% select(-ends_with("description")) %>% mutate_if(is.character, as.factor) %>% summary()

```



Debug
====

Debug {.tabset}
----

### Debug

``` {r debug_overview}
cat("DEBUG: getwd =", getwd(), "\n")
cat("DEBUG: taskdir =", taskdir, "\n")
```

### compare

```{r debug_compare}
cat("DEBUG: compare:", taskdir, "\n")
compare %>% mutate_if(is.character, as.factor) %>% str()
compare %>% mutate_if(is.character, as.factor) %>% summary()

```

### measures

```{r debug_measures}
cat("DEBUG: measures:", taskdir, "\n")
measures %>% mutate_if(is.character, as.factor) %>% str()
measures %>% mutate_if(is.character, as.factor) %>% summary()

```

### orgref

```{r debug_orgref}
cat("DEBUG: orgref:", taskdir, "\n")
orgref %>% mutate_if(is.character, as.factor) %>% str()
orgref %>% mutate_if(is.character, as.factor) %>% summary()

```

### indmap

```{r debug_indmap}
cat("DEBUG: indmap:", taskdir, "\n")
indmap %>% mutate_if(is.character, as.factor) %>% str()
indmap %>% select(-ends_with("description")) %>% mutate_if(is.character, as.factor) %>% summary()

```


About
====

Row 1
-----------------------------------------------------------------------

### About

Here is some content.
